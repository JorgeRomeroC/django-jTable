{% extends 'bases/index.html' %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-6">
      <table class="table table-hover" id="editableTable">
        <thead>
          <tr>
            <th scope="col">Id</th>
            <th scope="col">Código</th>
            <th scope="col">Descripción</th>
            <th scope="col">Acción</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    
    </div>
    <div class="col-6">
      <div class="row">
        <div class="col">
          <button type="button" class="btn btn-info" id="btnReload" onclick="recargar();">Cargar</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock%}

{% block js%}
<script>
  $(document).ready(function(){
    recargar()
  })

  function recargar(){
    $.ajax({
        headers: {'X-CSRFToken': "{{csrf_token}}"},
        url:"{% url 'app:reload'%}",
        type:"GEST",
        success: function(r){
          console.log(r)
          datos = r.datos;
          console.log(datos)

          $("table > tbody").empty()
          var tabla = $("table")

          var rows = $.map(datos,function(value,index){
            return `<tr>
            <td>${value.id}</td><td>${value.codigo}</td>
            <td>${value.descripcion}</td>
            </tr>`
          })
          $("table > tbody").html(rows.join(''))

          $("#editableTable").find('th[name="buttons"]').remove()

          $("#editableTable").SetEditable({
            // bootstrap: false,
            columnsEd: "1,2",
            onEdit: function(cEd){
              console.log(cEd)
              var i = cEd[0].childNodes[1].innerHTML
              var c = cEd[0].childNodes[2].innerHTML
              var d = cEd[0].childNodes[4].innerHTML
              // alert(c)
              // alert(d)

              var url = `edit/${i}`
              var data = {"codigo":c,"descripcion":d}

              $.ajax ({
                  url : url,
                  headers: {'X-CSRFToken': "{{csrf_token}}"},
                  type: "POST",
                  data: data,
                  success: function(r){
                    // alert("Editado")
                    mensaje("Guardado Satisfatoriamente")
                  },
                  error: function(jqXHR,textStatus,error)
                  {
                    console.log(error)
                  },
                  complete: function(xhr,status){
                    console.log("Finalizada")
                    limpiar()
                    recargar()
                  }
                })
            },
            onBeforeDelete: function(cEd){
              var i = cEd[0].childNodes[1].innerHTML
              borrar(i)
            },
            onDelete: function(){
              recargar()
            }
          })
        },
        error: function(jqXHR,textStatus,error){
          console.log(error)
        },
        complete: function(xhr,status){
          console.log("FINALIZADO")
        }
      })
  }

  function borrar(id){

  Swal.fire({
    title: `¿Borrar ${id}?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Si, Borrar',
    cancelButtonText: "No. No Borrar"
  }).then((result) => {
    if (result.isConfirmed) {
      var url = `delete/${id}`

      $.ajax ({
          url : url,
          headers: {'X-CSRFToken': "{{csrf_token}}"},
          type: "POST",
          success: function(r){
            // alert("Borrado")
            mensaje("Borrado Satisfactoriamente","¡Atención!")
          },
          error: function(jqXHR,textStatus,error)
          {
            console.log(error)
          },
          complete: function(xhr,status){
            console.log("Finalizada")
            recargar()
          }
        })    
    }else{
      mensaje("No se borró nada")
    }
  })

  }
</script>
{% endblock%}